# 1. 介绍

## 1.1 设计初衷

互联网协议（The Internet Protocol）旨在用于分组交换式计算机通信网络的互联系统中。此类系统此前被称为 “互联网络（catenet）”[1]。该互联网协议的核心功能包括：

1. 将称为 “数据报（datagrams）” 的数据块从源端传输至目的端，其中源端与目的端均为通过固定长度地址标识的主机；

2. 如需通过 “小包网络（small packet networks）” 传输，该协议还支持对过长的数据报进行分片（fragmentation）与重组（reassembly）;

## 1.2 范围

互联网协议（The internet protocol）的范围被特意限制为：仅提供在互联网络系统中，将一 “包” 比特（即一个互联网数据报）从源端传输到目的端所需的核心功能。它不包含以下机制：

+ 增强端到端数据可靠性；

+ 流量控制；

+ 数据排序

+ 或其他在主机到主机（host-to-host）协议中常见的服务

互联网协议可以利用其底层支撑网络提供的服务，以实现不同类型和质量的通信服务。

## 1.3 接口

该协议（指 IP 协议）在互联网环境中，由主机到主机（host-to-host）协议调用。同时，该协议会调用本地网络协议，将互联网数据报传输到下一个网关（gateway）或目标主机。

例如，一个 TCP 模块会调用互联网模块（IP 模块），将一个 TCP 段（包括 TCP 头部和用户数据）作为互联网数据报的数据部分。TCP 模块会提供地址和其他参数填充到互联网头部，
并将其作为调用参数传递给互联网模块。随后，互联网模块会创建一个互联网数据报，并调用本地网络接口来传输该互联网数据报。

例如，在 ARPANET 环境中，互联网模块（IP 模块）会调用一个本地网络模块（local net module）。该模块会在互联网数据报（IP 数据报）前添加一个 1822 头部（leader）[2]，
从而构成一个 ARPANET 消息（message），以便传输给 IMP（接口信息处理机）。ARPANET 地址由本地网络接口（local network interface） 从互联网地址（IP 地址）派生而来，
这个 ARPANET 地址指向 ARPANET 中的某个主机，而该主机可能是通往其他网络的网关（gateway）。

## 1.4 操作

互联网协议（IP 协议）实现了两项基本功能：**寻址**（addressing） 与 **分片**（fragmentation）。

互联网模块利用互联网报头中携带的地址，将互联网数据报朝着其目的地址传输。而为传输选择路径的行为，被称为路由选择（routing）。

当有必要通过 “小包网络” 传输时，互联网模块（IP 模块）会利用互联网头部中的字段对互联网数据报进行分片和重组。

IP 协议的运行模型如下：参与互联网通信的每台主机，以及用于互联各网络的每个网关中，均部署有一个互联网模块（IP 模块）。这些模块遵循统一的规则，用于解析地址字段、对互联网数据报进行分片与重组；
此外，这些模块（尤其网关中的模块）还具备路由决策及其他相关功能的处理流程。

互联网协议（IP 协议）将每个互联网数据报视为独立的实体，与其他任何互联网数据报均无关联。该协议中不存在连接（connections） 或逻辑电路（logical circuits）（无论虚拟与否）。

互联网协议（IP 协议）通过四项关键机制提供其服务：服务类型（Type of Service）、生存时间（Time to Live）、选项（Options） 及 头部校验和（Header Checksum）。

服务类型（Type of Service, ToS）用于指示期望的服务质量。该服务类型是一组抽象化或通用化的参数，其特征对应构成互联网的各网络中所提供的服务选项。网关在为互联网数据报路由时，可利用这一服务类型指示，
为特定网络选择实际的传输参数、确定下一跳使用的网络，或选定下一个网关。

生存时间（Time to Live, TTL）用于指示互联网数据报生命周期的上限。它由数据报的发送方设置，并在传输路径中经过的每个处理节点（如网关）处递减。若该生存时间在互联网数据报到达目的地之前降至零，则该数据报会被销毁。生存时间可被理解为一种自毁时限。

选项（Options）字段提供了在某些情况下必需或有用，但在最常见的通信中却非必需的控制功能。这些选项包括时间戳（timestamps）、安全性（security）和特殊路由（special routing）等设置。

头部校验和（Header Checksum）用于验证在处理互联网数据报时所使用的信息（即 IP 头部信息）在传输过程中是否被正确传输。（IP 数据报的数据部分可能包含错误，但头部校验和不负责验证这部分。）如果头部校验和验证失败，检测到该错误的设备（通常是路由器或目的主机）会立即丢弃该互联网数据报。

互联网协议（IP 协议）不提供可靠的通信服务。该协议中：
+ 既无端到端（end-to-end） 的确认机制，也无逐跳（hop-by-hop） 的确认机制；
+ 仅通过头部校验和保障头部完整性，不对数据部分进行差错控制；
+ 不存在重传（retransmissions）机制；
+ 不存在流量控制（flow control）机制；


检测到的错误可通过互联网控制消息协议（Internet Control Message Protocol, ICMP）[3] 进行报告，该协议（ICMP）已集成于互联网模块（IP 模块）中实现。

# 2. 概述

## 2.1 和其他协议的关系

下图展示了互联网协议（IP 协议）在协议分层结构（protocol hierarchy） 中的位置：

```
 +------+ +-----+ +-----+     +-----+
 |Telnet| | FTP | | TFTP| ... | ... |
 +------+ +-----+ +-----+     +-----+
       |   |         |           |
      +-----+     +-----+     +-----+
      | TCP |     | UDP | ... | ... |
      +-----+     +-----+     +-----+
         |           |           |
      +--------------------------+----+
      | Internet Protocol & ICMP |
      +--------------------------+----+
      |
      +---------------------------+
      | Local Network Protocol |
      +---------------------------+
        Protocol Relationships
              Figure 1.

```

互联网协议（IP 协议）的接口一侧对接上层的主机到主机协议（host-to-host protocols），另一侧对接本地网络协议（local network protocols）。在此语境下，
“本地网络（local network）” 既可以是一栋建筑内的小型网络，也可以是像阿帕网（ARPANET）这样的大型网络。

## 2.2 工作模式

一个数据报从一个应用程序传输到另一个应用程序的运作模型，可通过以下场景来说明：

  我们假设本次传输将涉及一个中间网关（路由器）。

  发送端的应用程序准备好其数据，然后调用其本地的互联网模块（IP 模块），请求将这些数据作为一个数据报发送出去。在调用时，应用程序会将目的地址和其他参数作为参数传递给 IP 模块。

  IP 模块会准备一个数据报头部，并将应用程序的数据附加在头部之后，组成一个完整的 IP 数据报。

  随后，IP 模块会为这个互联网地址（即目的 IP 地址） 确定一个本地网络地址。在这个场景中，这个本地网络地址就是一个网关（的链路层地址）。

  IP 模块将这个数据报和本地网络地址（即网关的链路层地址）发送给本地网络接口。
  
  本地网络接口创建一个本地网络头部（如以太网帧头），并将 IP 数据报附加在其后，然后通过本地网络发送出去。
  
  数据报到达网关主机时，仍被封装在本地网络头部中。网关的本地网络接口会剥离掉这个头部，将 IP 数据报交给网关的互联网模块。
  
  网关的互联网模块从 IP 头部的目的 IP 地址判断出，该数据报需要被转发到另一个网络中的主机。
  
  网关的互联网模块为目标主机确定一个新的本地网络地址（即目标主机在第二个网络中的链路层地址）。
  
  它调用该网络的本地网络接口来发送数据报。
  
  这个新的本地网络接口创建一个新的本地网络头部，附加在 IP 数据报上，然后将其发送给目的主机。
  
  在目的主机上，本地网络接口剥离掉这个最后的本地网络头部，将 IP 数据报交给目的主机的互联网模块。
  
  目的主机的互联网模块确定该数据报是发送给本机上的某个应用程序的。
  
  它响应一个系统调用（如 recv()），将数据报中的数据传递给应用程序，并将源 IP 地址和其他参数作为调用结果返回

```
Application                                               Application
 Program                                                    Program
       \                                                     /
      Internet Module         Internet Module          Internet Module
             \                  /         \                /
             LNI-1           LNI-1       LNI-2          LNI-2
                \            /              \           /
                Local Network 1            Local Network 2
                           Transmission Path
                              Figure 2

```

## 2.3 功能描述

互联网协议（IP 协议）的功能或目的，是使数据报在一组互联的网络中传输。这一过程通过将数据报从一个互联网模块（IP 模块）传递到另一个互联网模块来实现，
直至抵达目的地。这些互联网模块部署在互联网系统中的主机和网关内。数据报基于对互联网地址（IP 地址） 的解析，通过各个独立网络从一个互联网模块路由到
另一个互联网模块。因此，互联网协议的一项关键机制便是互联网地址。

在将消息从一个互联网模块路由到另一个互联网模块的过程中，数据报可能需要穿越一个最大数据包大小（MTU）小于该数据报尺寸的网络。为了克服这个困难，
互联网协议中提供了一种分片机制（fragmentation mechanism）。

寻址（Addressing）
  协议中明确区分名称（names）、地址（addresses） 与路由（routes）[4]：名称指示 “我们要找的对象”；地址指示 “对象所在的位置”；路由指示 “到达该位置的路径”。
  互联网协议（IP 协议）主要处理地址相关事宜：由上层协议（即主机到主机协议或应用层协议）负责 “名称到地址” 的映射（如 DNS 协议将域名解析为 IP 地址）；
  由互联网模块（IP 模块）负责 “互联网地址到本地网络地址” 的映射（如 ARP 协议将 IP 地址解析为 MAC 地址）；
  由下层流程（即本地网络协议或网关相关流程）负责 “本地网络地址到路由” 的映射（如网关通过路由表将本地网络地址关联到转发路径）。

  互联网地址为固定长度的 4 个字节（32 位），结构由 “网络号（network number）” 和 “本地地址（local address，又称‘剩余字段’rest field）” 组成。互联网地址分为三种格式（即地址类别）：
  A 类地址（Class A）：最高位为 0，后续 7 位为网络号，最后 24 位为本地地址；
  B 类地址（Class B）：最高两位为 10，后续 14 位为网络号，最后 16 位为本地地址；
  C 类地址（Class C）：最高三位为 110，后续 21 位为网络号，最后 8 位为本地地址。

  在 “互联网地址到本地网络地址” 的映射过程中需注意：一台物理主机必须能够 “模拟多台独立主机”，即支持使用多个不同的互联网地址（如一台服务器配置多个 IP 地址提供不同服务）。
  
  部分主机还会具备多个物理接口（即 “多宿主” multi-homing）—— 也就是说，协议需支持一台主机通过多个物理接口接入网络，且每个物理接口可配置多个逻辑互联网地址。

分片（Fragmentation）

  当一个互联网数据报在一个允许大型数据包的本地网络中产生，而必须穿越一个限制数据包尺寸更小的本地网络才能到达目的地时，对该数据报进行分片是必要的。

  一个互联网数据报可以被标记为 “不分片（don't fragment）”。任何被如此标记的数据报在任何情况下都不得被互联网层分片。如果一个标记为 “不分片” 的数据报不进行分片就无法交付到目的地，那么它将被丢弃。

  在一个对互联网协议模块不可见的本地网络内部发生的分片、传输和重组过程，被称为内部网分片（intranet fragmentation），这种机制是可以被使用的 [6]。

  互联网分片和重组过程需要能够将一个数据报分割成任意数量的片段，这些片段随后能被重新组装起来。

  片段的接收方使用 ** 标识（identification）** 字段来确保不同数据报的片段不会被混在一起。** 片偏移（fragment offset）** 字段告知接收方该片段在原始数据报中的位置。
  片偏移和长度字段共同决定了该片段覆盖原始数据报的哪一部分。更多片段（more-fragments）标志位（通过被重置为 0）指示最后一个片段。这些字段提供了重组数据报所需的足够信息。
  
  标识字段用于区分一个数据报的片段和另一个数据报的片段。一个互联网数据报的源协议模块会将标识字段设置为一个值，这个值对于该源 - 目的地址对和协议来说，在数据报处于互联网系统中的整个生命周期内必须是唯一的。
  一个完整的数据报（未分片）的源协议模块会将更多片段（more-fragments）标志位设置为0，并将片偏移（fragment offset）设置为0。

  为了对一个长互联网数据报进行分片，一个互联网协议模块（例如，在网关中）会创建两个新的互联网数据报，并将原长数据报的互联网头部字段内容复制到这两个新的头部中。
  原长数据报的数据部分会在一个8 字节（64 位）的边界上被分割成两部分（第二部分的数据长度不一定是 8 字节的整数倍，但第一部分必须是）。我们将第一部分数据包含的 8 字节块的数量称为 NFB（Number of Fragment Blocks，分片块数）。
  + 第一部分数据被放入第一个新互联网数据报中。
  + 第一个新数据报的 **总长度（Total Length** 字段被设置为该数据报的实际长度。
  + 第一个新数据报的更多分片（More Fragments）标志位被设置为1。
  + 第二部分数据被放入第二个新互联网数据报中。
  + 第二个新数据报的 **总长度（Total Length）** 字段被设置为该数据报的实际长度。
  + 第二个新数据报的 **更多分片（More Fragments）** 标志位保持与原长数据报相同的值。
  + 第二个新数据报的片偏移（Fragment Offset）字段被设置为原长数据报的该字段值加上 NFB。

  这个过程（指 IP 数据报的分片过程）可以推广到 n 路分割，而不仅仅是上述描述的两路分割。

  为了重组一个互联网数据报的分片，一个互联网协议模块（例如在目的主机中）会将那些标识（identification）、源地址（source）、**目的地址（destination）和协议（protocol）** 这四个字段值都相同的互联网数据报组合在一起。
  重组过程是这样完成的：根据每个分片头部中的 **片偏移（fragment offset）** 字段所指示的相对位置，将该分片的数据部分放置在正确的位置上。第一个分片的片偏移字段值为0，而最后一个分片的更多分片（more-fragments）标志位会被重置为 0（即 MF = 0）。

## 2.4 网关

网关（Gateways）实现互联网协议（IP）以在不同网络之间转发数据报（forward datagrams）。网关还实现网关到网关协议（Gateway to Gateway Protocol, GGP）[7]，以协调 **路由（routing）** 和其他互联网控制信息（internet control information）。

网关中无需实现上层协议，且网关到网关协议（GGP）的功能会被整合到互联网模块（IP 模块）中。

# 3. 规范说明

## 3.1 网络头格式

以下是互联网头部（IP 头部）的内容摘要：

```
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |Version|  IHL  |Type of Service|         Total Length          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |        Identification         |Flags|     Fragment Offset     |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Time to Live  |    Protocol   |        Header Checksum        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                         Source Address                        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                      Destination Address                      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                  Options                   |     Padding      |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
               Example Internet Datagram Header
                           Figure 4
```


