# TCP

TCP（Transmission Control Protocol，传输控制协议）为应用提供一种可靠的、按序的、字节流服务。应用层字节流通过 TCP 报文段（TCP segments）在网络中传输，每个 TCP 报文段均以互联网协议（IP）数据报的形式发送。

+ 可靠性
  + 通过序列号检测数据包丢失；
  + 通过逐段校验和检测数据错误；
  + 通过重传机制纠正上述问题；

TCP 连接支持双向数据流传输，不过应用程序也可根据自身需求，仅选择单向发送数据。
  
  单向使用场景：应用层可通过关闭半连接（```shutdown(SHUT_WR)```）明确告知对方不再发送数据，仅保留接收能力（如服务器端处理完请求后，关闭写通道，仅读取客户端可能的后续数据）。


TCP 通过端口号识别应用层服务，并在主机间实现不同数据流的多路复用。

## 头格式

```
 0                   1                   2                   3
 
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Source Port                 | Destination Port                |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                    Sequence Number            |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                             Acknowledgment Number             |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Data  |       |C|E|U|A|P|R|S|F|                               |
 | Offset| Rsrvd |W|C|R|C|S|S|Y|I|           Window              |
 |       |       |R|E|G|K|H|T|N|N|                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 | Checksum                    | Urgent Pointer                  |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                     [Options] |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               :
 :                                                   Data        :
 :                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

+ Source Port（源端口）

  16位字段，标识发送端的应用服务；

+ Destination Port（目的端口号）

  16位字段，标识接收端的目标应用服务；

+ Sequence Number（序号）

  32位字段，标识本分段中第一个数据字节的序号（SYN 标志置1时列外）：若 SYN = 1，该字段为初始序号，后续第一个数据字节序号为 ISN + 1；连接建立后用于保障数据有序传输和去重。

+ Acknowledgment Number（确认号）

  32位字段，仅当 ACK 标志置 1 时有效：（1）标识发送方期望接收的下一个序号（即已成功接收对方数据的最后一个序号 + 1）；（2）连接建立后，该字段必传（体现 TCP 的可靠确认机制）；

+ Data Offset(数据偏移量)

  4 位字段，单位为 32 位字（4字节），表示 TCP 头部的总长度：

  （1）计算公式：头部长度 = 数据偏移量 * 4 字节；

  （2）用于标识数据部分的起始位置

  （3）因头部可包含选项，长度不固定，但必须为 32 位的整数倍；、

+ Reserved（保留字段）

  4位字段，预留用于未来扩展。（1）发送方生成分段时必须置0；（2）接收方若未实现对应扩展功能，需忽略该字段的非零值；

+ CWR（拥塞窗口缩减标志）

  1 位标志，用于拥塞控制，标识发送方已收到接收方的拥塞通知并缩减拥塞窗口；

+ ECE（ECN 回显标志）

  1 位标志，与 ECN（显式拥塞通知）机制配合（详见 RFC 9293 对应章节），用于回显接收方检测到的网络拥塞状态。

+ URG（紧急指针有效标志）

  1 位标志，置 1 时表示 “紧急指针” 字段有效，通知接收方优先处理该分段中的紧急数据；

+ ACK（确认标志）

  1 位标志，置 1 时表示 “确认号” 字段有效（TCP 可靠传输的核心标志之一）

+ PSH（推送标志）

  1 位标志，触发 “推送功能”：（1） 发送方置 1 时，要求接收方立即将该分段的数据推送至应用层（而非缓存等待）；

+ RST（复位标志）

  1 位标志，用于强制重置 TCP 连接：（1）触发场景：接收方收到无效连接的分段、连接异常中断后恢复；

+ SYN（同步标志）
  
  1 位标志，用于 TCP 连接建立：（1）三次握手阶段，发起方发送 SYN=1 的分段，协商初始序号（ISN）；（2）仅在连接建立时置 1，数据传输阶段为 0；

+ FIN（终止标志）

  1 位标志，用于主动关闭 TCP 连接：（1）发送方置 1 表示无更多数据要发送，请求关闭连接；（2）需等待对方确认（FIN+ACK）后，连接进入半关闭状态；

+ Window（窗口大小）

  16位字段，标识接收方当前的接收缓冲区可用空间（单位：字节）：

  （1）用于 TCP 流量控制，避免发送方发送速率超过接收方处理能力；

  （2）接收方通过该字段动态告知发送方可发送的数据量；

+ Checksum（校验和）

  16 位字段，用于校验 TCP 头部 + 数据的完整性：

  （1）覆盖范围：TCP 伪头部（含 IP 源 / 目的地址、协议号）、TCP 头部、用户数据；

  （2）接收方校验失败则丢弃该分段，依赖重传机制保障可靠性。

+ Urget Pointer（紧急指针）

  16 位字段，仅当 URG=1 时有效：

  （1）表示从当前 “序号” 开始，到紧急数据结束的偏移量（即紧急数据的最后一个字节序号 = 当前序号 + 紧急指针 - 1）；

  （2）用于标记紧急数据范围（如中断信号、关键指令）；

+ Options（选项字段）

+ Data（数据部分）


## 序列号

  TCP 设计中的一个核心理念是：通过 TCP 连接传输的每个字节（octet） 都分配有一个序列号。由于每个字节都被编号排序，因此它们中的每一个都能被确认。TCP 采用的确认机制为累积确认（cumulative acknowledgment） —— 即确认号为 X 意味着，
所有序号小于 X（但不包含 X）的字节均已被接收方成功接收。该机制使得在存在重传的场景下，能够直接、简便地检测出重复数据。数据段（segment）内字节的编号规则如下：紧跟在 TCP 头部之后的第一个数据字节编号最小，后续字节按连续递增的方式依次编号。

高性能网络场景下的序列号循环周期，会短于基础 TCP 设计所考量的兆比特每秒（Mbps）级场景。在 1Gbps 速率下，序列号循环周期为 34 秒；10Gbps 速率下仅为 3 秒；而 100Gbps 速率下约为 1/3 秒。针对这些高性能场景，TCP 时间戳选项（TCP Timestamp Options）
与序列号回绕保护（PAWS，Protection Against Wrapped Sequences）机制，提供了检测并丢弃旧重复报文段的必要能力



### 初始化序列号选择

## 建立一个连接




  
  
  
  
